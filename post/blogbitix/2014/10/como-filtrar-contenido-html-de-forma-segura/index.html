<!DOCTYPE html><html data-debug-enabled="true" data-locale="es_ES" xmlns="http://www.w3.org/1999/xhtml"><head><meta content="Apache Tapestry Framework (version 5.4-beta-16)" name="generator"/><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta pagina="Post"/><title>Cómo filtrar contenido HTML de forma segura | Blog Bitix</title><!-- Resources --><link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400,700"/><link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css"/><link title="Portada" type="application/atom+xml" rel="alternate" href="/feed.atom.xml"/><link type="image/png" rel="icon" href="/assets/images/favicon.png"/><meta content="Post" name="tapestry-page-name"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/bootstrap/css/bootstrap.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tapestry.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/exception-frame.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tapestry-console.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tree.css"/><link type="text/css" rel="stylesheet" href="/assets/css/core.css"/></head><body data-page-initialized="false"><script type="text/javascript">document.write("<div class=\"pageloading-mask\"><div></div></div>");</script><header><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-4"><h1><a class="blogstack" href="/"><span class="glyphicon glyphicon-th"></span> Blog <span class="stack">Stack</span></a></h1></div><div class="col-xs-12 col-sm-12 col-md-6"><nav role="navigation"><ul class="list-unstyled list-inline"><li><a class="header" href="/">Inicio</a></li><li><a class="header" href="/archive">Archivo</a></li><li><a class="header" href="/faq">Preguntas frecuentes</a></li><li><a class="header" href="/faq#aggregate">¿Quieres agregar tu bitácora?</a></li></ul></nav></div><div class="col-xs-6 col-sm-6 col-md-2"><a title="Fuente RSS, ¡suscríbete a BS!" alt="Fuente RSS" class="header" href="/feed.atom.xml"><span class="header icon entypo"></span></a><a title="Twitter, ¡sigue a BS!" alt="Twitter" class="header" href="http://twitter.com/blogstackinfo"><span class="header icon entypo-social"></span></a></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><h4>Un poco más que un agregador/planeta de bitácoras sobre programación, desarrollo, software libre, gnu/linux, tecnología, ...</h4></div></div></div><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div class="imagen-cabecera"><div class="imagen"><div class="col-xs-12 col-sm-12 col-md-12" id="billboard"></div></div></div></div></div></div></header><div class="container-fluid content"><div class="row"><div class="col-xs-12 col-sm-12 col-md-8 content"><article itemtype="http://schema.org/BlogPosting" itemscope=""><a id="content"></a><header><h2><a href="/post/blogbitix/2014/10/como-filtrar-contenido-html-de-forma-segura"><span itemprop="headline">Cómo filtrar contenido HTML de forma segura</span></a></h2></header><div class="row labels"><div class="col-md-12"><a class="label" href="/label/programacion"><img title="programacion" alt="programacion" src="/assets/images/labels/programacion.png"/></a><a class="label" href="/label/java"><img title="java" alt="java" src="/assets/images/labels/java.png"/></a></div></div><section class="post-data"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div><span>Escrito por <span itemprop="author">pico.dev</span> en la bitácora <a href="http://picodotdev.github.io/blog-bitix/">Blog Bitix</a>, <a href="http://picodotdev.github.io/blog-bitix/2014/10/como-filtrar-contenido-html-de-forma-segura/"><span itemprop="sameAs">artículo original</span></a></span></div><div><span datetime="2015-01-16T11:00" itemprop="dateModified">Actualizado el viernes, 16 de enero de 2015 a las 11:00 UTC</span></div><div><span>
Etiquetado como
blog-stack, <a href="/label/programacion"><span itemprop="articleSection">programacion</span></a>, <a href="/label/java"><span itemprop="articleSection">java</span></a>, planeta-codigo</span></div></div></div></section><div class="text-justify post-content"><div class="share-this only-twitter"><span displayText="Tweet" class="st_twitter_vcount" st_url="http://www.blogstack.info/post/blogbitix/2014/10/como-filtrar-contenido-html-de-forma-segura" st_title="Cómo filtrar contenido HTML de forma segura | Blog Bitix"></span></div><script src="http://w.sharethis.com/button/buttons.js" type="text/javascript"></script><script type="text/javascript">stLight.options({publisher: "ur-3b2014fd-82e-9968-7e00-5ee51fb88bb2", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script><span itemprop="name"><div style="float: right; text-align: right;"> 
 <img src="http://picodotdev.github.io/blog-bitix/images/custom/logotipos/java.png" alt="Java" title="Java" />
 <br /> 
</div> 
<p>Algunos sitios y aplicaciones pueden tener la necesidad de <a href="http://picodotdev.github.io/blog-bitix/2014/10/que-es-y-como-hacer-web-scraping-en-java/">&laquo;scrapear&raquo; el contenido de sitios web</a> para extraer informaci&oacute;n de ellos y posteriormente usarla de alguna forma. El contenido &laquo;scrapeado&raquo; o obtenido de una fuente externa debe ser filtrado, si no es filtrado y posteriormente es servido a los usuarios puede envi&aacute;rseles principalmente scripts con contenido malicioso (provocando un ataque <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting, XSS</a>) o causar una desmaquetaci&oacute;n al visualizar el contenido. A la hora de implementar la agregaci&oacute;n de contenido de forma segura en <a href="http://www.blogstack.info">Blog Stack</a>, contenido obtenido de una fuente RSS o Atom pero que en esencia es HTML he usado la librer&iacute;a <a href="http://jsoup.org/">jsoup</a>, de tal forma que solo el contenido considerado seguro o confiable de los art&iacute;culos sea agregado.</p> 
<p>&iquest;Que puede pasar si en una fuente env&iacute;a elementos &lt;script&gt;, &lt;iframe&gt; u &lt;object&gt;? Los &lt;script&gt; son c&oacute;digo que se env&iacute;a al navegador del usuario y que podr&iacute;an explotar alg&uacute;n fallo de seguridad del navegador que usen, los &lt;iframe&gt; permiten cargar contenido de una tercera fuente. En definitiva podr&iacute;an hacer que visitar Blog Stack fuese inseguro. Pero no permitir incluir estos elementos tambi&eacute;n har&iacute;a que no se pudiesen mostrar v&iacute;deos de <a href="https://www.youtube.com/">YouTube</a>, <a href="https://vimeo.com/">Vimeo</a>, <a href="https://gist.github.com/">Gist</a> de GitHub, presentaciones de <a href="https://speakerdeck.com/">SpeackerDeck</a> y se perder&iacute;a parte del contenido original. La soluci&oacute;n que he aplicado en Blog Stack es permitir el contenido de esos elementos que provienen de una fuente considerada confiable, es decir, si se trata de un iframe cuyo elemento src proviene de YouTube se permite el contenido ya que se supone que YouTube y su contenido es seguro. De esta forma el contenido puede agregarse de forma segura sin perder nada del contenido original.</p> 
<p>Para hacer el filtrado de HTML en java podemos usar jsoup, para ello deberemos usar la clase <a href="http://jsoup.org/apidocs/org/jsoup/safety/Whitelist.html">Whitelist</a> que proporciona jsoup o implementar una clase que la extienda con las etiquetas y sus atributos que consideramos seguros. En Blog Stack he necesitado implementar una clase Whitelist agreg&aacute;ndole la funcionalidad que deseaba.</p> 
<p>Esta es la implementaci&oacute;n de la clase Whitelist, con el m&eacute;todo addTag se indican los tags permitidos, con addAttributes se indican los atributos permitidos para cada etiqueta, addProtocols se indican los protocolos permitidos para cada etiqueta y atributo, finalmente el m&eacute;todo addAttribute permite usar una expresi&oacute;n regular para el valor del atributo, esto se comprueba en el m&eacute;todo isSafeAttribute:</p> 
<p></p>
<div>
 <script src="https://gist.github.com/picodotdev/7b3dddb9093fbfcdd67c.js?file=AppWhitelist.java"></script> 
 <noscript>
  <pre><code>package info.blogstack.misc;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.jsoup.nodes.Attribute;
import org.jsoup.nodes.Element;
import org.jsoup.safety.Whitelist;

public class AppWhitelist extends Whitelist {

	private List&lt;Map&lt;String, String&gt;&gt; attributes;

	private AppWhitelist() {
		attributes = new ArrayList&lt;&gt;();
	}

	public static Whitelist relaxed() {
		Whitelist wl = new AppWhitelist()
				.addTags(&quot;a&quot;, &quot;b&quot;, &quot;blockquote&quot;, &quot;br&quot;, &quot;caption&quot;, &quot;cite&quot;, &quot;code&quot;, &quot;col&quot;, &quot;colgroup&quot;, &quot;dd&quot;, &quot;div&quot;, &quot;dl&quot;, &quot;dt&quot;, &quot;em&quot;, &quot;h1&quot;, &quot;h2&quot;, &quot;h3&quot;, &quot;h4&quot;, &quot;h5&quot;, &quot;h6&quot;, &quot;i&quot;,
						&quot;img&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;p&quot;, &quot;pre&quot;, &quot;q&quot;, &quot;small&quot;, &quot;strike&quot;, &quot;strong&quot;, &quot;sub&quot;, &quot;sup&quot;, &quot;table&quot;, &quot;tbody&quot;, &quot;td&quot;, &quot;tfoot&quot;, &quot;th&quot;, &quot;thead&quot;, &quot;tr&quot;, &quot;u&quot;, &quot;ul&quot;)

				.addAttributes(&quot;a&quot;, &quot;href&quot;, &quot;title&quot;)
				.addAttributes(&quot;blockquote&quot;, &quot;cite&quot;)
				.addAttributes(&quot;col&quot;, &quot;span&quot;, &quot;width&quot;)
				.addAttributes(&quot;colgroup&quot;, &quot;span&quot;, &quot;width&quot;)
				.addAttributes(&quot;img&quot;, &quot;align&quot;, &quot;alt&quot;, &quot;height&quot;, &quot;src&quot;, &quot;title&quot;, &quot;width&quot;)
				.addAttributes(&quot;ol&quot;, &quot;start&quot;, &quot;type&quot;)
				.addAttributes(&quot;q&quot;, &quot;cite&quot;)
				.addAttributes(&quot;table&quot;, &quot;summary&quot;, &quot;width&quot;)
				.addAttributes(&quot;td&quot;, &quot;abbr&quot;, &quot;axis&quot;, &quot;colspan&quot;, &quot;rowspan&quot;, &quot;width&quot;)
				.addAttributes(&quot;th&quot;, &quot;abbr&quot;, &quot;axis&quot;, &quot;colspan&quot;, &quot;rowspan&quot;, &quot;scope&quot;, &quot;width&quot;)
				.addAttributes(&quot;ul&quot;, &quot;type&quot;)

				.addProtocols(&quot;a&quot;, &quot;href&quot;, &quot;ftp&quot;, &quot;http&quot;, &quot;https&quot;, &quot;mailto&quot;)
				.addProtocols(&quot;blockquote&quot;, &quot;cite&quot;, &quot;http&quot;, &quot;https&quot;)
				.addProtocols(&quot;cite&quot;, &quot;cite&quot;, &quot;http&quot;, &quot;https&quot;)
				.addProtocols(&quot;img&quot;, &quot;src&quot;, &quot;http&quot;, &quot;https&quot;)
				.addProtocols(&quot;q&quot;, &quot;cite&quot;, &quot;http&quot;, &quot;https&quot;)
				
				//
				.addTags(&quot;script&quot;, &quot;iframe&quot;, &quot;noscript&quot;)
				.addAttributes(&quot;div&quot;, &quot;style&quot;)
				.addAttributes(&quot;img&quot;, &quot;style&quot;)
				.addAttributes(&quot;script&quot;, &quot;src&quot;, &quot;data-.*&quot;)
				.addAttributes(&quot;iframe&quot;, &quot;src&quot;, &quot;width&quot;, &quot;height&quot;, &quot;frameborder&quot;, &quot;allowfullscreen&quot;, &quot;style&quot;, &quot;marginwidth&quot;, &quot;marginheight&quot;, &quot;frameborder&quot;, &quot;scrolling&quot;)
				.addAttributes(&quot;object&quot;, &quot;width&quot;, &quot;height&quot;)
				.addAttributes(&quot;param&quot;, &quot;name&quot;, &quot;value&quot;)
				.addAttributes(&quot;embed&quot;, &quot;src&quot;, &quot;type&quot;, &quot;width&quot;, &quot;height&quot;, &quot;allowscriptaccess&quot;, &quot;allowfullscreen&quot;);
		return wl;
	}

	public Whitelist addAttribute(String tag, String key, String regexp) {
		Map&lt;String, String&gt; attribute = new HashMap&lt;&gt;();
		attribute.put(&quot;tag&quot;, tag);
		attribute.put(&quot;key&quot;, key);
		attribute.put(&quot;regexp&quot;, regexp);
		return this;
	}

	@Override
	protected boolean isSafeAttribute(String tagName, Element el, Attribute attr) {
		for (Map&lt;String, String&gt; attribute : attributes) {
			String tag = attribute.get(&quot;tag&quot;);
			String key = attribute.get(&quot;key&quot;);
			String regexp = attribute.get(&quot;regexp&quot;);

			if (tag.equals(tagName) &amp;&amp; attr.getKey().matches(key) &amp;&amp; attr.getValue().matches(regexp)) {
				return true;
			}
		}
		return super.isSafeAttribute(tagName, el, attr);
	}
}
</code></pre>
 </noscript>
</div> 
<p></p> 
<p>Y esta es la forma de usar la clase a trav&eacute;s de <a href="http://jsoup.org/apidocs/org/jsoup/Jsoup.html#clean%28java.lang.String,%20java.lang.String,%20org.jsoup.safety.Whitelist%29">Jsoup.clean</a>:</p> 
<p></p>
<div>
 <script src="https://gist.github.com/picodotdev/7b3dddb9093fbfcdd67c.js?file=IndexServiceImpl.java"></script> 
 <noscript>
  <pre><code>AppWhitelist whitelist = (AppWhitelist) AppWhitelist.relaxed();
whitelist.addAttribute(&quot;script&quot;, &quot;src&quot;, &quot;^http[s]?://speakerdeck.com/.*$&quot;);
whitelist.addAttribute(&quot;script&quot;, &quot;src&quot;, &quot;^http[s]?://gist.github.com/.*$&quot;);
whitelist.addAttribute(&quot;iframe&quot;, &quot;src&quot;, &quot;^http[s]?://www.youtube.com/embed/.*$&quot;);
whitelist.addAttribute(&quot;iframe&quot;, &quot;src&quot;, &quot;^http[s]?://player.vimeo.com/video/.*$&quot;);
whitelist.addAttribute(&quot;iframe&quot;, &quot;src&quot;, &quot;^http[s]?://rcm-eu.amazon-adsystem.com/.*$&quot;);
whitelist.addAttribute(&quot;embed&quot;, &quot;src&quot;, &quot;^http[s]?://www.youtube.com/v/.*$&quot;);
String content = Jsoup.clean(postContent.toString(), source.getPageUrl(), whitelist);</code></pre>
 </noscript>
</div> 
<p></p> 
<p>El <a href="https://github.com/picodotdev/blog-stack">c&oacute;digo fuente completo de BS</a> junto con el &laquo;scrapeado&raquo; y el uso de esta clase est&aacute; disponible en un repositorio de GitHub.</p> 
<p>Referencia:<br /> <a href="http://picodotdev.github.io/blog-bitix/2014/10/que-es-y-como-hacer-web-scraping-en-java/">Qu&eacute; es y c&oacute;mo hacer &laquo;web scraping&raquo; en Java</a><br /> <a href="http://picodotdev.github.io/blog-bitix/2015/01/como-hacer-un-substring-de-una-cadena-html/">Como hacer un substring de una cadena html</a></p></span></div><section><a id="share"></a><h1>Compartir</h1><div class="share-this"><span displayText="Tweet" class="st_twitter_vcount" st_url="http://www.blogstack.info/post/blogbitix/2014/10/como-filtrar-contenido-html-de-forma-segura" st_title="Cómo filtrar contenido HTML de forma segura | Blog Bitix"></span><span displayText="Facebook" class="st_facebook_vcount" st_url="http://www.blogstack.info/post/blogbitix/2014/10/como-filtrar-contenido-html-de-forma-segura" st_title="Cómo filtrar contenido HTML de forma segura | Blog Bitix"></span><span displayText="Google +" class="st_googleplus_vcount" st_url="http://www.blogstack.info/post/blogbitix/2014/10/como-filtrar-contenido-html-de-forma-segura" st_title="Cómo filtrar contenido HTML de forma segura | Blog Bitix"></span><span displayText="LinkedIn" class="st_linkedin_vcount" st_url="http://www.blogstack.info/post/blogbitix/2014/10/como-filtrar-contenido-html-de-forma-segura" st_title="Cómo filtrar contenido HTML de forma segura | Blog Bitix"></span><span displayText="Meneame" class="st_meneame_vcount" st_url="http://www.blogstack.info/post/blogbitix/2014/10/como-filtrar-contenido-html-de-forma-segura" st_title="Cómo filtrar contenido HTML de forma segura | Blog Bitix"></span></div><script src="http://w.sharethis.com/button/buttons.js" type="text/javascript"></script><script type="text/javascript">stLight.options({publisher: "ur-3b2014fd-82e-9968-7e00-5ee51fb88bb2", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script><div id="widget"></div></section><section><a id="comments"></a><h1>Comentar</h1><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = "blog-bitix";
var disqus_title = "Cómo filtrar contenido HTML de forma segura";
var disqus_url = "http://picodotdev.github.io/blog-bitix/2014/10/como-filtrar-contenido-html-de-forma-segura/";
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></section><hr/></article></div><div class="col-xs-12 col-sm-12 col-md-4"><aside><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section><h3>¡Suscríbete!</h3><ul class="list-unstyled"><li><a href="/label/programacion/feed.atom.xml"><span class="fa fa-rss"></span> Fuente de la etiqueta programacion</a></li><li><a href="/label/java/feed.atom.xml"><span class="fa fa-rss"></span> Fuente de la etiqueta java</a></li></ul></section></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div id="bigRectangle"></div></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section><h3>Redes sociales</h3><p>¿Te gusta Blog Stack? ¡Compártelo!</p><div class="social-networks"><!-- Facebook --><div class="social-network"><div data-share="true" data-show-faces="false" data-action="like" data-width="310" data-layout="box_count" data-href="http://www.blogstack.info/" class="fb-like"></div></div><!-- Google+ --><div class="social-network"><div class="g-plusone" data-href="http://www.blogstack.info/" data-size="tall"></div></div></div></section></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section id="lastPosts"></section></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div id="bigSkycraper"></div></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section id="lastPosts_0"></section></div></div></aside></div></div></div><footer><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div class="footer"><a href="/">Blog Stack</a> por <a href="https://twitter.com/picodotdev/">pico.dev</a> está publicado bajo la licencia de software libre <a href="http://www.gnu.org/licenses/agpl-3.0.html">GNU Affero General Public</a> en <a href="https://github.com/picodotdev/blog-stack">GitHub <span class="entypo-social"></span></a>.<br/>
El contenido agregado conserva la licencia de su bitácora.<br/>
«Powered by» <a href="https://github.com/picodotdev/blogstack">Blog Stack</a>, <a href="http://tapestry.apache.org/">Apache Tapestry</a>, <a href="https://www.openshift.com/">OpenShift</a>, <a href="https://pages.github.com/">GitHub Pages</a>, <a href="http://www.oracle.com/es/technologies/java/overview/index.html">Java</a> y más software libre o de código abierto, inspirado en <a href="http://octopress.org/">Octopress</a>.<br/><span class="copyleft">©</span> pico.dev 2015
</div></div></div></div></footer><div id="fb-root"></div><script type="text/javascript">var require = {
  "waitSeconds" : 300,
  "shim" : {
    "t5/core/typeahead" : [
      "jquery"
    ],
    "bootstrap/affix" : [
      "bootstrap/transition"
    ],
    "bootstrap/alert" : [
      "bootstrap/transition"
    ],
    "bootstrap/modal" : [
      "bootstrap/transition"
    ],
    "bootstrap/tab" : [
      "bootstrap/transition"
    ],
    "bootstrap/transition" : [
      "jquery"
    ],
    "bootstrap/button" : [
      "bootstrap/transition"
    ],
    "bootstrap/scrollspy" : [
      "bootstrap/transition"
    ],
    "bootstrap/collapse" : [
      "bootstrap/transition"
    ],
    "bootstrap/dropdown" : [
      "bootstrap/transition"
    ],
    "bootstrap/tooltip" : [
      "bootstrap/transition"
    ],
    "bootstrap/carousel" : [
      "bootstrap/transition"
    ],
    "bootstrap/popover" : [
      "bootstrap/tooltip"
    ]
  },
  "baseUrl" : "/modules"
};
</script><script src="/assets/tapestry5/require.js" type="text/javascript"></script><script src="/assets/tapestry5/underscore-1.5.2.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/prototype.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/scriptaculous.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/effects.js" type="text/javascript"></script><script src="/assets/tapestry5/t53-compatibility.js" type="text/javascript"></script><script src="/assets/tapestry5/jquery.js" type="text/javascript"></script><script src="/assets/tapestry5/jquery-noconflict.js" type="text/javascript"></script><script type="text/javascript">require(["t5/core/pageinit"], function(pi) { pi([], [
  "app/analytics",
  [
    "app/karmacracy:init",
    {
      "selector" : "#widget",
      "id" : 1031,
      "url" : "http://www.blogstack.info/post/blogbitix/2014/10/como-filtrar-contenido-html-de-forma-segura"
    }
  ],
  "app/disqus",
  "app/facebook",
  "app/googleplus",
  [
    "app/lastPosts:init",
    {
      "id" : "lastPosts",
      "source" : "blogbitix",
      "name" : "Blog Bitix"
    }
  ],
  [
    "app/lastPosts:init",
    {
      "id" : "lastPosts_0",
      "source" : "blogstack",
      "name" : "Blog Stack"
    }
  ],
  [
    "app/adsensem:init",
    {
      "blogstack" : {
        "adClient" : "ca-pub-3533636310991304",
        "adSlot" : "1397019380"
      },
      "ad" : {
        "adClient" : "ca-pub-3533636310991304",
        "adSlot" : "1397019380"
      }
    }
  ]
]); });</script></body></html>