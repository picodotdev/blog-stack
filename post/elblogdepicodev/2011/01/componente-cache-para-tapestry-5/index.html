<!DOCTYPE html><html data-debug-enabled="true" data-locale="es_ES" xmlns="http://www.w3.org/1999/xhtml"><head><meta content="Apache Tapestry Framework (version 5.4-beta-16)" name="generator"/><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta pagina="Post"/><title>Componente cache para Tapestry 5 | El blog de pico.dev</title><!-- Resources --><link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400,700"/><link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css"/><link title="Portada" type="application/atom+xml" rel="alternate" href="/feed.atom.xml"/><link type="image/png" rel="icon" href="/assets/images/favicon.png"/><meta content="Post" name="tapestry-page-name"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/bootstrap/css/bootstrap.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tapestry.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/exception-frame.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tapestry-console.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tree.css"/><link type="text/css" rel="stylesheet" href="/assets/css/core.css"/></head><body data-page-initialized="false"><script type="text/javascript">document.write("<div class=\"pageloading-mask\"><div></div></div>");</script><header><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-4"><h1><a class="blogstack" href="/"><span class="glyphicon glyphicon-th"></span> Blog <span class="stack">Stack</span></a></h1></div><div class="col-xs-11 col-sm-11 col-md-6"><nav role="navigation"><ul class="list-unstyled list-inline"><li><a href="/">Inicio</a></li><li><a href="/archive">Archivo</a></li><li><a href="/faq">Preguntas frecuentes</a></li><li><a href="/faq#aggregate">¿Quieres agregar tu bitácora?</a></li></ul></nav></div><div class="col-xs-11 col-sm-11 col-md-2 enlaces"><a href="/feed.atom.xml"><img title="Fuente RSS, ¡suscríbete!" alt="Fuente RSS" src="/assets/images/entypo/signal1.png"/></a><a href="http://twitter.com/blogstackinfo"><img title="Twitter, ¡sígueme!" alt="Twitter" src="/assets/images/entypo/twitter4.png"/></a></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><h4>Un poco más que un agregador/planeta de bitácoras sobre programación, desarrollo, software libre, gnu/linux, tecnología, ...</h4></div></div></div><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div class="imagen-cabecera"><div class="imagen"><div class="col-xs-12 col-sm-12 col-md-12" id="billboard"></div></div></div></div></div></div></header><div class="container-fluid content"><div class="row"><div class="col-xs-12 col-sm-12 col-md-8 content"><article itemtype="http://schema.org/BlogPosting" itemscope=""><a id="content"></a><header><h2><a href="/post/elblogdepicodev/2011/01/componente-cache-para-tapestry-5"><span itemprop="headline">Componente cache para Tapestry 5</span></a></h2></header><div class="row labels"><div class="col-md-12"><a class="label" href="/label/programacion"><img title="programacion" alt="programacion" src="/assets/images/labels/programacion.png"/></a><a class="label" href="/label/java"><img title="java" alt="java" src="/assets/images/labels/java.png"/></a><a class="label" href="/label/tapestry"><img title="tapestry" alt="tapestry" src="/assets/images/labels/tapestry.png"/></a></div></div><section class="post-data"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div><span>Escrito por <span itemprop="author">pico.dev</span> en la bitácora <a href="http://elblogdepicodev.blogspot.com.es/">El blog de pico.dev</a>, <a href="http://elblogdepicodev.blogspot.com/2011/01/componente-cache-para-tapestry-5.html"><span itemprop="sameAs">artículo original</span></a></span></div><div><span datetime="2011-01-12T12:43" itemprop="datePublished">Publicado el miércoles, 12 de enero de 2011 a las 12:43 UTC</span></div><div><span datetime="2011-02-18T18:52" itemprop="dateModified">Actualizado el viernes, 18 de febrero de 2011 a las 18:52 UTC</span></div><div><span>
Etiquetado como
<a href="/label/programacion"><span itemprop="articleSection">programacion</span></a>, <a href="/label/tapestry"><span itemprop="articleSection">tapestry</span></a>, <a href="/label/java"><span itemprop="articleSection">java</span></a></span></div></div></div></section><div class="text-justify post-content"><div class="share-this only-twitter"><span displayText="Tweet" class="st_twitter_vcount" st_url="http://www.blogstack.info/post/elblogdepicodev/2011/01/componente-cache-para-tapestry-5" st_title="Componente cache para Tapestry 5 | El blog de pico.dev"></span></div><script src="http://w.sharethis.com/button/buttons.js" type="text/javascript"></script><script type="text/javascript">stLight.options({publisher: "ur-3b2014fd-82e-9968-7e00-5ee51fb88bb2", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script><span itemprop="name"><div style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em; text-align: center;">
 <img height="132" src="http://1.bp.blogspot.com/_9zOwWD_PYL8/TOq7Y6w6wfI/AAAAAAAAAiU/DPBnmc4-2Sw/s320/tapestry.png" width="320" />
</div>En el desarrollo de un proyecto web suele ser interesante tener alguna forma de cachear el contenido de ciertas regiones din&aacute;micas de la p&aacute;gina que puede ser costoso generarlas pero que es poco habitual que var&iacute;en su contenido, como por ejemplo, el men&uacute;, el pie de p&aacute;gina u otras partes comunes. El cachear estas regiones ayuda a generar la p&aacute;gina m&aacute;s r&aacute;pidamente y supone un ahorro de recursos del servidor con lo que conseguimos dos importantes cosas: evitar que el usuario pierda el inter&eacute;s y se vaya de nuestra web porque la p&aacute;gina tarda mucho en cargarse y poder atender a m&aacute;s usuarios con los mismos recursos del servidor.
<br />
<br />Para Tapestry 4 hab&iacute;a disponible un componente cache en la librer&iacute;a 
<a href="http://tapfx.sourceforge.net/">tapfx</a> pero estos componentes no son compatibles con Tapestry 5. Con lo que he tenido la necesidad de desarrollar uno compatible con esta versi&oacute;n (y me ha sorprendido lo sencillo que me ha resultado como ver&eacute;is por el n&uacute;mero de lineas del mismo).
<br />
<br />El componente Cache que he desarrollado hace uso de la librer&iacute;a est&aacute;ndar de facto para esta funcionalidad en Java 
<a href="http://ehcache.org/">ehcache</a>, a la que si tenemos necesidad posteriormente podemos a&ntilde;adirle caracter&iacute;sticas de cache distribuida con 
<a href="http://www.terracotta.org/">terracotta</a> de forma simple y sin afectar al c&oacute;digo del componente.
<br />
<br />Sin m&aacute;s vayamos a ver el c&oacute;digo del componente:
<br />
<br />
<div>
 <pre>package com.blogspot.elblogdepicodev.tapestry.components;<br /><br />import java.util.Collections;<br /><br />import net.sf.ehcache.CacheManager;<br />import net.sf.ehcache.Ehcache;<br /><br />import org.apache.tapestry5.BindingConstants;<br />import org.apache.tapestry5.MarkupWriter;<br />import org.apache.tapestry5.annotations.Parameter;<br />import org.apache.tapestry5.annotations.Property;<br />import org.apache.tapestry5.dom.Element;<br />import org.apache.tapestry5.ioc.annotations.Inject;<br />import org.apache.tapestry5.services.RequestGlobals;<br /><br />public class Cache {<br /><br />    @Inject<br />    @Property<br />    private RequestGlobals requestGlobals;<br />    <br />    @Parameter(required = true, allowNull = false, defaultPrefix = BindingConstants.LITERAL)<br />    private String cacheName;<br />    <br />    @Parameter(required = true, allowNull = false, defaultPrefix = BindingConstants.LITERAL)<br />    private String key;<br />    <br />    @Parameter(value = &quot;false&quot;, defaultPrefix = BindingConstants.PROP)<br />    private boolean disabled;<br />    <br />    @Inject<br />    private CacheManager cacheManager;<br /><br />    boolean beforeRenderBody(MarkupWriter writer) {<br />        if (!disabled) {<br />            Ehcache cache = cacheManager.getEhcache(cacheName);<br />            net.sf.ehcache.Element element = (net.sf.ehcache.Element) cache.get(key + &quot;-&quot; + requestGlobals.getRequest().getLocale().toString());<br />            if (element != null) {<br />                String value = (String) element.getValue();<br />                writer.writeRaw(value);<br />                return false;<br />            }<br />            writer.element(&quot;cache&quot;, Collections.EMPTY_LIST.toArray());<br />        }<br />        return true;        <br />    }<br />    <br />    void afterRenderBody(MarkupWriter writer) {<br />        if (!disabled) {<br />            Element e = writer.getElement();<br />            if (e.getName().equals(&quot;cache&quot;)) {<br />                String value = e.getChildMarkup();<br />                writer.end();<br />                e.pop();<br />            <br />                net.sf.ehcache.Element element = new net.sf.ehcache.Element(key + &quot;-&quot; + requestGlobals.getRequest().getLocale().toString(), value);<br />                Ehcache cache = cacheManager.getEhcache(cacheName);<br />                cache.put(element);<br />            }<br />        }<br />    }<br />}</pre>
</div>
<br />Como se puede ver en el c&oacute;digo el componente tiene 3 par&aacute;metros: 
<b>cacheName</b> para saber en que cache de ehcache se cachear&aacute; el contenido html, 
<b>key</b> para identificar el contenido en la cache y 
<b>disabled</b> para habilitar la cache o deshabilitarla seg&uacute;n alguna condici&oacute;n.
<br />
<br />La funcionanilidad est&aacute; dividida en dos m&eacute;todos: beforeRenderBody y afterRenderBody. En el primero lo que se hace es comprobar si se habilita el uso de la cache, si es que no se devuelve true para que se procesen el cuerpo del componente, si est&aacute; habilitada la cache (disabled == false) se comprueba si en la cache indicada por el par&aacute;metro cacheName existe una clave indicada por el par&aacute;metro key, si existe el contenido html del cuerpo del componente se ha generado anteriormente y ya est&aacute; cachedo por lo que no es necesario volver a procesarlo y se escribe&nbsp;directamente&nbsp;el contenido, finalmente se devuelve false para que no se procese el cuerpo del componente. Si se llama al m&eacute;todo&nbsp;afterRenderBody es que se ha procesado el cuerpo del componente, si la cache est&aacute; habilitada tendremos que almacenar el contenido html generado por los componentes del cuerpo del componente cache para posteriores usos, se obtiene la cache y en la clave indicada junto con el locale en el que se ha generado el contenido se guarda el html del cuerpo.
<br />
<br />Otra parte del uso de este componente es definir el servicio CacheManager que se inyecta en el componente. Para ello tendremos que definir un m&eacute;todo (buildCacheManager) en la clase del 
<a href="http://tapestry.apache.org/tapestry-ioc-modules.html">m&oacute;dulo de la aplicaci&oacute;n</a> para construir el servicio y poder inyectarlo en el componente.
<br />
<br />
<div>
 <pre>package com.blogspot.elblogdepicodev.tapestry.services;<br /><br />import java.util.Collection;<br /><br />import net.sf.ehcache.Cache;<br />import net.sf.ehcache.CacheManager;<br />import net.sf.ehcache.config.CacheConfiguration;<br />import net.sf.ehcache.constructs.blocking.BlockingCache;<br /><br />import org.apache.tapestry5.SymbolConstants;<br />import org.apache.tapestry5.ioc.Configuration;<br />import org.apache.tapestry5.ioc.MappedConfiguration;<br />import org.apache.tapestry5.ioc.annotations.SubModule;<br />import org.apache.tapestry5.ioc.services.Coercion;<br />import org.apache.tapestry5.ioc.services.CoercionTuple;<br />import org.apache.tapestry5.util.StringToEnumCoercion;<br /><br />...<br /><br />public class AppModule {<br /><br />    ...<br />    <br />    public static CacheManager buildCacheManager() {<br />        CacheConfiguration defaultCacheConfig = new CacheConfiguration(&quot;defaultCache&quot;, 10000);<br />        defaultCacheConfig.setDiskStorePath(&quot;java.io.tmpdir&quot;);<br />        defaultCacheConfig.setEternal(false);<br />        defaultCacheConfig.setTimeToIdleSeconds(120);<br />        defaultCacheConfig.setTimeToLiveSeconds(120);<br />        defaultCacheConfig.setOverflowToDisk(false);<br />        defaultCacheConfig.setDiskPersistent(false);<br />        defaultCacheConfig.setMemoryStoreEvictionPolicy(&quot;LRU&quot;);<br />        Cache defaultCache = new Cache(defaultCacheConfig);<br /><br />        CacheConfiguration fragmentosTapestryConfig = new CacheConfiguration(&quot;fragmentos-tapestry&quot;, 50);<br />        fragmentosTapestryConfig.setEternal(false);<br />        fragmentosTapestryConfig.setTimeToIdleSeconds(1800);<br />        fragmentosTapestryConfig.setTimeToLiveSeconds(3600);<br />        fragmentosTapestryConfig.setOverflowToDisk(false);<br />        fragmentosTapestryConfig.setDiskPersistent(false);<br />        fragmentosTapestryConfig.setMemoryStoreEvictionPolicy(&quot;LRU&quot;);<br />        Cache fragmentosTapestryCache = new Cache(fragmentosTapestryConfig);        <br />        <br />        CacheManager cacheManager = new CacheManager();<br />        cacheManager.addCache(defaultCache);<br />        cacheManager.addCache(fragmentosTapestryCache);<br />        <br />        Cache cache = cacheManager.getCache(&quot;fragmentos-tapestry&quot;);<br />        BlockingCache fragmentosTapestryBlockingCache = new BlockingCache(cache);<br />        cacheManager.replaceCacheWithDecoratedCache(cache, fragmentosTapestryBlockingCache);<br />        <br />        return cacheManager;<br />    }<br />}</pre>
</div>
<br />La configuraci&oacute;n del ehcache puede hacerse definiendo un archivo ehcache.xml o como he preferido en este caso de forma program&aacute;tica, aqu&iacute; se definen dos cache: la cache por defecto y una cache para los fragmentos html que cachear&aacute; el componente Cache.
<br />
<br />El uso del componente cache ser&iacute;a tan sencillo como:
<br />
<br />
<div>
 <pre>&lt;t:cache cacheName=&quot;fragmentos-tapestry&quot; key=&quot;ejemplo&quot;&gt;<br />    [Componentes de tapestry que generar&aacute;n en contenido HTML que se cachear&aacute;]<br />&lt;/t:cache&gt;</pre>
</div>
<br />Y esto es todo, unas 65 l&iacute;neas de c&oacute;digo que pueden mejorar notablemente el tiempo de respuesta de nuestras aplicaciones del ya de por si excelente rendimiento que ofrece Tapestry. Si este componente te ha resultado interesante o puede serte &uacute;til para tu proyecto siente libre de usarlo, modificarlo o proponer mejoras, solo pido que dejes un comentario en esta entrada para conocer a otras personas que usan Tapestry o tienen inter&eacute;s en &eacute;l.
<br />
<br />Referencia:
<br />
<a href="http://elblogdepicodev.blogspot.com/2010/05/documentacion-sobre-apache-tapestry.html">Documentaci&oacute;n sobre Apache Tapestry</a>
<br />
<a href="http://ehcache.org/">http://ehcache.org/</a>
<br />
<a href="http://www.terracotta.org/">http://www.terracotta.org/</a>
<br />
<a href="http://andyhot.di.uoa.gr/tapfx/app">http://andyhot.di.uoa.gr/tapfx/app</a>
<br />
<a href="http://tapfx.sourceforge.net/">http://tapfx.sourceforge.net/</a></span></div><section><a id="share"></a><h1>Compartir</h1><div class="share-this"><span displayText="Tweet" class="st_twitter_vcount" st_url="http://www.blogstack.info/post/elblogdepicodev/2011/01/componente-cache-para-tapestry-5" st_title="Componente cache para Tapestry 5 | El blog de pico.dev"></span><span displayText="Facebook" class="st_facebook_vcount" st_url="http://www.blogstack.info/post/elblogdepicodev/2011/01/componente-cache-para-tapestry-5" st_title="Componente cache para Tapestry 5 | El blog de pico.dev"></span><span displayText="Google +" class="st_googleplus_vcount" st_url="http://www.blogstack.info/post/elblogdepicodev/2011/01/componente-cache-para-tapestry-5" st_title="Componente cache para Tapestry 5 | El blog de pico.dev"></span><span displayText="LinkedIn" class="st_linkedin_vcount" st_url="http://www.blogstack.info/post/elblogdepicodev/2011/01/componente-cache-para-tapestry-5" st_title="Componente cache para Tapestry 5 | El blog de pico.dev"></span><span displayText="Meneame" class="st_meneame_vcount" st_url="http://www.blogstack.info/post/elblogdepicodev/2011/01/componente-cache-para-tapestry-5" st_title="Componente cache para Tapestry 5 | El blog de pico.dev"></span></div><script src="http://w.sharethis.com/button/buttons.js" type="text/javascript"></script><script type="text/javascript">stLight.options({publisher: "ur-3b2014fd-82e-9968-7e00-5ee51fb88bb2", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script><div id="widget"></div></section><section><a id="comments"></a><h1>Comentar</h1><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = "elblogdepicodev";
var disqus_title = "Componente cache para Tapestry 5";
var disqus_url = "http://elblogdepicodev.blogspot.com/2011/01/componente-cache-para-tapestry-5.html";
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></section><hr/></article></div><aside class="col-xs-12 col-sm-12 col-md-4"><section><h3>Redes sociales</h3><p>¿Te gusta Blog Stack? ¡Compártelo con tus amigos!</p><div class="social-networks"><!-- Facebook --><div data-share="true" data-show-faces="false" data-action="like" data-width="310" data-layout="standard" data-href="http://www.blogstack.info/" class="fb-like"></div><!-- Google+ --><g:plusone size="standard" annotation="inline" href="http://www.blogstack.info/" width="310"></g:plusone></div></section><section><h3>¡Suscríbete!</h3><ul class="list-unstyled"><li><a href="/label/programacion/feed.atom.xml"><span class="fa fa-rss"></span> Fuente de la etiqueta programacion</a></li><li><a href="/label/tapestry/feed.atom.xml"><span class="fa fa-rss"></span> Fuente de la etiqueta tapestry</a></li><li><a href="/label/java/feed.atom.xml"><span class="fa fa-rss"></span> Fuente de la etiqueta java</a></li></ul></section><div id="bigRectangle"></div><section id="lastPosts"></section><div class="row"><div class="col-xs-3 col-md-2"><div id="wideSkycraper"></div></div></div><section id="lastPosts_0"></section></aside></div></div><footer><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div class="footer"><a href="/">Blog Stack</a> por <a href="https://twitter.com/picodotdev/">pico.dev</a> está publicado bajo la licencia de software libre <a href="http://www.gnu.org/licenses/agpl-3.0.html">GNU Affero General Public</a>.<br/>
El contenido agregado conserva la licencia de su bitácora.<br/>
«Powered by» <a href="https://github.com/picodotdev/blogstack">Blog Stack</a>, <a href="http://tapestry.apache.org/">Apache Tapestry</a>, <a href="https://www.openshift.com/">OpenShift</a>, <a href="https://pages.github.com/">GitHub Pages</a>, <a href="http://www.oracle.com/es/technologies/java/overview/index.html">Java</a> y más software libre o de código abierto, inspirado en <a href="http://octopress.org/">Octopress</a>.<br/><span class="copyleft">©</span> pico.dev 2014
</div></div></div></div></footer><div id="fb-root"></div><script type="text/javascript">var require = {
  "waitSeconds" : 300,
  "shim" : {
    "t5/core/typeahead" : [
      "jquery"
    ],
    "bootstrap/affix" : [
      "bootstrap/transition"
    ],
    "bootstrap/alert" : [
      "bootstrap/transition"
    ],
    "bootstrap/modal" : [
      "bootstrap/transition"
    ],
    "bootstrap/tab" : [
      "bootstrap/transition"
    ],
    "bootstrap/transition" : [
      "jquery"
    ],
    "bootstrap/button" : [
      "bootstrap/transition"
    ],
    "bootstrap/scrollspy" : [
      "bootstrap/transition"
    ],
    "bootstrap/collapse" : [
      "bootstrap/transition"
    ],
    "bootstrap/dropdown" : [
      "bootstrap/transition"
    ],
    "bootstrap/tooltip" : [
      "bootstrap/transition"
    ],
    "bootstrap/carousel" : [
      "bootstrap/transition"
    ],
    "bootstrap/popover" : [
      "bootstrap/tooltip"
    ]
  },
  "baseUrl" : "/modules"
};
</script><script src="/assets/tapestry5/require.js" type="text/javascript"></script><script src="/assets/tapestry5/underscore-1.5.2.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/prototype.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/scriptaculous.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/effects.js" type="text/javascript"></script><script src="/assets/tapestry5/t53-compatibility.js" type="text/javascript"></script><script src="/assets/tapestry5/jquery.js" type="text/javascript"></script><script src="/assets/tapestry5/jquery-noconflict.js" type="text/javascript"></script><script type="text/javascript">require(["t5/core/pageinit"], function(pi) { pi([], [
  "app/analytics",
  [
    "app/karmacracy:init",
    {
      "selector" : "#widget",
      "id" : 164,
      "url" : "http://www.blogstack.info/post/elblogdepicodev/2011/01/componente-cache-para-tapestry-5"
    }
  ],
  "app/disqus",
  "app/facebook",
  "app/googleplus",
  [
    "app/lastPosts:init",
    {
      "id" : "lastPosts",
      "source" : "elblogdepicodev",
      "name" : "El blog de pico.dev"
    }
  ],
  [
    "app/lastPosts:init",
    {
      "id" : "lastPosts_0",
      "source" : "blogstack",
      "name" : "Blog Stack"
    }
  ],
  [
    "app/adsensem:init",
    {
      "blogstack" : {
        "adClient" : "ca-pub-3533636310991304",
        "adSlotBillboard" : "1397019380",
        "adSlotHorizontalSkycraper" : "1397019380",
        "adSlotBigRectangle" : "2873752587",
        "adSlotWideSkycraper" : "1896546988"
      },
      "ad" : {
        "adClient" : "ca-pub-3533636310991304",
        "adSlotBillboard" : "1397019380",
        "adSlotHorizontalSkycraper" : "1397019380",
        "adSlotBigRectangle" : "2873752587",
        "adSlotWideSkycraper" : "1896546988"
      }
    }
  ]
]); });</script></body></html>