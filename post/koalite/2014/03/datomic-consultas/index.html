<!DOCTYPE html><html data-debug-enabled="true" data-locale="es_ES" xmlns="http://www.w3.org/1999/xhtml"><head><meta content="Apache Tapestry Framework (version 5.4-beta-16)" name="generator"/><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta pagina="Post"/><title>Datomic: consultas | Koalite</title><!-- Resources --><link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400,700"/><link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css"/><link title="Portada" type="application/atom+xml" rel="alternate" href="/feed.atom.xml"/><link type="image/png" rel="icon" href="/assets/images/favicon.png"/><meta content="Post" name="tapestry-page-name"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/bootstrap/css/bootstrap.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tapestry.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/exception-frame.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tapestry-console.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tree.css"/><link type="text/css" rel="stylesheet" href="/assets/css/core.css"/></head><body data-page-initialized="false"><script type="text/javascript">document.write("<div class=\"pageloading-mask\"><div></div></div>");</script><header><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-4"><h1><a class="blogstack" href="/"><span class="glyphicon glyphicon-th"></span> Blog <span class="stack">Stack</span></a></h1></div><div class="col-xs-12 col-sm-12 col-md-6"><nav role="navigation"><ul class="list-unstyled list-inline"><li><a class="header" href="/">Inicio</a></li><li><a class="header" href="/archive">Archivo</a></li><li><a class="header" href="/faq">Preguntas frecuentes</a></li><li><a class="header" href="/faq#aggregate">¿Quieres agregar tu bitácora?</a></li></ul></nav></div><div class="col-xs-6 col-sm-6 col-md-2"><a title="Fuente RSS, ¡suscríbete a BS!" alt="Fuente RSS" class="header" href="/feed.atom.xml"><span class="header icon entypo"></span></a><a title="Twitter, ¡sigue a BS!" alt="Twitter" class="header" href="http://twitter.com/blogstackinfo"><span class="header icon entypo-social"></span></a></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><h4>Un poco más que un agregador/planeta de bitácoras sobre programación, desarrollo, software libre, gnu/linux, tecnología, ...</h4></div></div></div><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div class="imagen-cabecera"><div class="imagen"><div class="col-xs-12 col-sm-12 col-md-12" id="billboard"></div></div></div></div></div></div></header><div class="container-fluid content"><div class="row"><div class="col-xs-12 col-sm-12 col-md-8 content"><article itemtype="http://schema.org/BlogPosting" itemscope=""><a id="content"></a><header><h2><a href="/post/koalite/2014/03/datomic-consultas"><span itemprop="headline">Datomic: consultas</span></a></h2></header><section class="post-data"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div><span>Escrito por <span itemprop="author">Juan María Hernández</span> en la bitácora <a href="http://blog.koalite.com/">Koalite</a>, <a href="http://feedproxy.google.com/~r/KoalitesBlog/~3/YDaMXEkOYH4/"><span itemprop="sameAs">artículo original</span></a></span></div><div><span datetime="2014-03-31T05:06" itemprop="datePublished">Publicado el lunes, 31 de marzo de 2014 a las 05:06 UTC</span></div><div><span>
Etiquetado como
datomic, nosql, clojure, development</span></div></div></div></section><div class="text-justify post-content"><div class="share-this only-twitter"><span displayText="Tweet" class="st_twitter_vcount" st_url="http://www.blogstack.info/post/koalite/2014/03/datomic-consultas" st_title="Datomic: consultas | Koalite"></span></div><script src="http://w.sharethis.com/button/buttons.js" type="text/javascript"></script><script type="text/javascript">stLight.options({publisher: "ur-3b2014fd-82e-9968-7e00-5ee51fb88bb2", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script><span itemprop="name"><p><img src="http://blog.koalite.com/wp-content/uploads/datomic-logo-medium.png" alt="datomic-logo-medium" width="250" height="240" /></p> 
<p>En los anteriores posts de esta serie describimos las <a href="http://blog.koalite.com/2014/03/datomic-una-base-de-datos-diferente/" title="Datomic, una base de datos diferente">caracter&iacute;sticas b&aacute;sicas de Datomic</a>, una base de datos inmutable, y vimos c&oacute;mo <a href="http://blog.koalite.com/2014/03/datomic-esquema-y-datos/">crear un esquema basado en atributos e insertar informaci&oacute;n</a> en &eacute;l.</p> 
<p>En este post vamos a ver c&oacute;mo podemos consultar la informaci&oacute;n almacenada en Datomic, y para ello seguiremos usando el (extremadamente simple) esquema de datos que creamos en el anterior post. Recordad que estaba formado por lo siguientes atributos:</p> 
<table> 
 <tbody>
  <tr> 
   <th>Nombre</th> 
   <th>Tipo</th> 
   <th>Cardinalidad</th> 
  </tr> 
  <tr> 
   <td>:person/name</td> 
   <td>string</td> 
   <td>1</td> 
  </tr> 
  <tr> 
   <td>:person/age</td> 
   <td>integer</td> 
   <td>1</td> 
  </tr> 
  <tr> 
   <td>:person/friends</td> 
   <td>reference</td> 
   <td>varios</td> 
  </tr> 
 </tbody>
</table> 
<h3>La base de datos como valor</h3> 
<p>Antes de empezar a lanzar consultas, es fundamental comprender la forma en que ve Datomic la base de datos. En otros sistemas de bases de datos, la base de datos es algo mutable, que contiene informaci&oacute;n que se va modificando a lo largo del tiempo y en la que, por tanto, vamos destruyendo la historia. Por ejemplo, en SQL Server, al lanzar un <code>update</code> sobre una tabla, perdemos la informaci&oacute;n de lo que hab&iacute;a antes. Sin embargo, Datomic est&aacute; basada en la idea de estructuras de datos inmutables, por lo que al insertar/actualizar/eliminar un valor lo que tendremos ser&aacute; dos “versiones” de la base de datos, la versi&oacute;n N con el estado anterior y la versi&oacute;n N+1 con el nuevo estado.</p> 
<p>Esto hace que la manera de lanzar consultas a la base de datos sea diferente a la forma en que se ejecutaban transacciones contra ella. Si record&aacute;is el post anterior, para ejecutar una transacci&oacute;n se usaba la funci&oacute;n <code>transact</code> que recib&iacute;a como par&aacute;metros las operaciones a ejecutar y la conexi&oacute;n a la base de datos contra la que quer&iacute;amos actuar. Cuando lanzamos una consulta, no la lanzamos contra una conexi&oacute;n a la base de datos, sino contra el valor de la base de datos en un momento de tiempo determinado. Esto es as&iacute; porque, como acabamos de decir, Datomic mantiene la historia completa de los cambios que se han ido produciendo en los datos y al realizar una consulta podemos elegir contra qu&eacute; momento de la historia queremos lanzarla.</p> 
<p>La manera de obtener una referencia al valor de la base de datos en el instante actual es mediante la funci&oacute;n <code>db</code>:</p> 
<pre>
(def dbval (d/db conn))
</pre> 
<p>Puesto que el valor de <code>dbval</code> no cambiar&aacute; <em>nunca</em>, podemos garantizar que las consultas que lancemos ofreceran una visi&oacute;n correcta de la informaci&oacute;n. El mal uso de este concepto da lugar a un error peligroso que es <a href="http://www.rkn.io/2014/02/10/datomic-antipatterns-connnnn/">usar la conexi&oacute;n (y no la base de datos) como valor</a>.</p> 
<h3>La sintaxis de las consultas</h3> 
<p>En lugar de utilizar un lenguaje de consultas espec&iacute;fico como ocurre como las bases de datos relacionales y el uso de SQL, las consultas de Datomic se construyen con estructuras de datos est&aacute;ndar de clojure (algo similar a lo que ocurr&iacute;a con las transacciones). </p> 
<p>Las consultas se ejecutan con la funci&oacute;n <code>q</code>, que recibe un vector con una especie de DSL que representa la consulta y el valor de la base datos (no la conexi&oacute;n) contra el que ejecutar la consulta.</p> 
<p>En este post no vamos a ver en detalle todos los tipos de consultas que se pueden utilizar, para eso est&aacute; la <a href="http://docs.datomic.com/query.html">documentaci&oacute;n sobre consultas de Datomic</a>, pero s&iacute; veremos algunos ejemplos para hacernos una idea de qu&eacute; aspecto tienen las consultas sobre Datomic.</p> 
<p>Por ejemplo, si queremos conocer todas las personas que hay en la base de datos, podemos utilizar la siguiente consulta:</p> 
<pre>
(def result (d/q '[:find ?e :where [?e :person/name]] dbval))
</pre> 
<p>Lo primero que puede llamar la atenci&oacute;n es que el vector que contiene la consulta lleva una comilla (<em>quote</em>) delante. Esto es necesario porque no queremos que se eval&uacute;e en el momento de invocar a la funci&oacute;n <code>q</code> (de hecho provocar&iacute;a un error porque el s&iacute;mbolo <code>?e</code> no est&aacute; definido en ning&uacute;n sitio), sino que queremos pasar ese vector literalmente a <code>q</code> para que lo interprete como quiera.</p> 
<p>En la clausula <code>:where</code> indicamos el tipo de relaci&oacute;n que queremos que se cumpla. En este caso, simplemente estamos pidiendo algo que tenga un atributo <code>:person/name</code>, es decir, todas las personas. Podr&iacute;amos limitarlo m&aacute;s incluyendo el valor del atributo y escribir algo as&iacute;:</p> 
<pre>
(def result (d/q '[:find ?e :where [?e :person/name &quot;Alejandro&quot;]] dbval))
;; =&gt; #{[17592186045418] [17592186045419]}
</pre> 
<p>En cualquier caso, al final la consulta devolver&aacute; los resultados que indiquemos en el <code>:find</code>, en este caso el <code>Id</code> de las entidades que cumplan que tienen definido el atributo <code>:person/name</code> con el valor “Alejandro”. El resultado de <code>q</code> es un conjunto donde cada elemento es un vector con los valores indicados en el <code>:find</code>.</p> 
<p>Cuando obtenemos el <code>Id</code> de una entidad (como en el ejemplo anterior) podemos obtener la entidad completa utilizando la funci&oacute;n <code>entity</code>:</p> 
<pre>
(def alejandro (d/entity dbval (ffirst result))
</pre> 
<p>Esto nos permitir&aacute; acceder a todas los atributos asociados a la entidad como si se tratara de un <code>map</code>. Hay que tener en cuenta que la carga de la entidad se realiza de forma <em>lazy</em>, as&iacute; que hasta que no se intenta hacer nada con ella, el <code>map</code> s&oacute;lo contendr&aacute; el <code>Id</code>, aunque podemos forzar la evaluaci&oacute;n con la funci&oacute;n <code>touch</code>.</p> 
<p>Adem&aacute;s de obtener los <code>Ids</code> de las entidades, podemos lanzar consultas para extraer directamente otra informaci&oacute;n. Por ejemplo, podr&iacute;amos obtener los nombres y las edades de todas las personas con esta consulta:</p> 
<pre>
(def names-and-ages (d/q '[:find ?name ?age 
                           :where [?e :person/name ?name]
                                  [?e :person/age ?age]]
                         dbval))
;; =&gt; #{[&quot;Alejandro&quot; 53] [&quot;Marcial&quot; 71]}
</pre> 
<p>En este caso a&ntilde;adimos varias restricciones en el <code>:where</code> y Datomic busca registros que satisfagan todas ellas. Es interesante ver el uso del s&iacute;mbolo <code>?e</code>, que no lo devolvemos en la consulta pero sirve para enlazar las dos condiciones. </p> 
<p>La forma de definir consultas en Datomic tiene estilo similar al usado en <a href="http://blog.koalite.com/2013/08/que-es-la-programacion-logica/" title="&iquest;Qu&eacute; es la Programaci&oacute;n L&oacute;gica?">programaci&oacute;n l&oacute;gica</a> (aunque la implementaci&oacute;n interna es completamente diferente). Se marcan unos predicados con variables libres y el sistema intenta unificarlas para obtener todas las respuestas posibles. </p> 
<p>Es posible crear consultas mucho m&aacute;s complejas, incluir en ellas funciones, parametrizarlas y muchas cosas m&aacute;s. Si quieres ver de lo que es capaz el motor de consultas de Datomic, puedes <a href="http://docs.datomic.com/query.html">ver su documentaci&oacute;n</a>.</p> 
<h3>Resumen</h3> 
<p>Una de las caracter&iacute;sticas m&aacute;s distintivas e importantes de Datomic es su inmutabilidad, y eso se refleja especialmente en la manera en que se realizan las consultas, utilizando la base de datos como un valor en lugar de lanzando consultas contra una base de datos cambiando a trav&eacute;s de una conexi&oacute;n.</p> 
<p>Las consultas se construyen con estructuras de datos est&aacute;ndar de clojure y tienen una sintaxis bastante simple que recuerda a la sintaxis de algunos lenguajes l&oacute;gicos.</p> 
<p>Con este post doy por cerrada, de momento, la serie sobre Datomic. Todav&iacute;a quedar&iacute;an muchas cosas que ver, pero por lo menos ya tenemos una idea de lo que ofrece estas base de datos tan particular y de c&oacute;mo podemos trabajar con ella.</p> 
<p><strong>Posts relacionados:</strong></p>
<ol> 
 <li><a href="http://blog.koalite.com/2014/03/datomic-esquema-y-datos/" title="Datomic: esquema y datos">Datomic: esquema y datos</a></li> 
 <li><a href="http://blog.koalite.com/2014/03/datomic-una-base-de-datos-diferente/" title="Datomic, una base de datos diferente">Datomic, una base de datos diferente</a></li> 
</ol>
<img src="http://feeds.feedburner.com/~r/KoalitesBlog/~4/YDaMXEkOYH4" height="1" width="1" /></span></div><section><a id="share"></a><h1>Compartir</h1><div class="share-this"><span displayText="Tweet" class="st_twitter_vcount" st_url="http://www.blogstack.info/post/koalite/2014/03/datomic-consultas" st_title="Datomic: consultas | Koalite"></span><span displayText="Facebook" class="st_facebook_vcount" st_url="http://www.blogstack.info/post/koalite/2014/03/datomic-consultas" st_title="Datomic: consultas | Koalite"></span><span displayText="Google +" class="st_googleplus_vcount" st_url="http://www.blogstack.info/post/koalite/2014/03/datomic-consultas" st_title="Datomic: consultas | Koalite"></span><span displayText="LinkedIn" class="st_linkedin_vcount" st_url="http://www.blogstack.info/post/koalite/2014/03/datomic-consultas" st_title="Datomic: consultas | Koalite"></span><span displayText="Meneame" class="st_meneame_vcount" st_url="http://www.blogstack.info/post/koalite/2014/03/datomic-consultas" st_title="Datomic: consultas | Koalite"></span></div><script src="http://w.sharethis.com/button/buttons.js" type="text/javascript"></script><script type="text/javascript">stLight.options({publisher: "ur-3b2014fd-82e-9968-7e00-5ee51fb88bb2", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script><div id="widget"></div></section><hr/></article></div><div class="col-xs-12 col-sm-12 col-md-4"><aside><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div id="bigRectangle"></div></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section><h3>Redes sociales</h3><p>¿Te gusta Blog Stack? ¡Compártelo!</p><div class="social-networks"><!-- Facebook --><div class="social-network"><div data-share="true" data-show-faces="false" data-action="like" data-width="310" data-layout="box_count" data-href="http://www.blogstack.info/" class="fb-like"></div></div><!-- Google+ --><div class="social-network"><div class="g-plusone" data-href="http://www.blogstack.info/" data-size="tall"></div></div></div></section></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section id="lastPosts"></section></div></div><div class="row"><div class="col-xs-3 col-md-2"><div id="wideSkycraper"></div></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section id="lastPosts_0"></section></div></div></aside></div></div></div><footer><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div class="footer"><a href="/">Blog Stack</a> por <a href="https://twitter.com/picodotdev/">pico.dev</a> está publicado bajo la licencia de software libre <a href="http://www.gnu.org/licenses/agpl-3.0.html">GNU Affero General Public</a> en <a href="https://github.com/picodotdev/blog-stack">GitHub <span class="entypo-social"></span></a>.<br/>
El contenido agregado conserva la licencia de su bitácora.<br/>
«Powered by» <a href="https://github.com/picodotdev/blogstack">Blog Stack</a>, <a href="http://tapestry.apache.org/">Apache Tapestry</a>, <a href="https://www.openshift.com/">OpenShift</a>, <a href="https://pages.github.com/">GitHub Pages</a>, <a href="http://www.oracle.com/es/technologies/java/overview/index.html">Java</a> y más software libre o de código abierto, inspirado en <a href="http://octopress.org/">Octopress</a>.<br/><span class="copyleft">©</span> pico.dev 2014
</div></div></div></div></footer><div id="fb-root"></div><script type="text/javascript">var require = {
  "waitSeconds" : 300,
  "shim" : {
    "t5/core/typeahead" : [
      "jquery"
    ],
    "bootstrap/affix" : [
      "bootstrap/transition"
    ],
    "bootstrap/alert" : [
      "bootstrap/transition"
    ],
    "bootstrap/modal" : [
      "bootstrap/transition"
    ],
    "bootstrap/tab" : [
      "bootstrap/transition"
    ],
    "bootstrap/transition" : [
      "jquery"
    ],
    "bootstrap/button" : [
      "bootstrap/transition"
    ],
    "bootstrap/scrollspy" : [
      "bootstrap/transition"
    ],
    "bootstrap/collapse" : [
      "bootstrap/transition"
    ],
    "bootstrap/dropdown" : [
      "bootstrap/transition"
    ],
    "bootstrap/tooltip" : [
      "bootstrap/transition"
    ],
    "bootstrap/carousel" : [
      "bootstrap/transition"
    ],
    "bootstrap/popover" : [
      "bootstrap/tooltip"
    ]
  },
  "baseUrl" : "/modules"
};
</script><script src="/assets/tapestry5/require.js" type="text/javascript"></script><script src="/assets/tapestry5/underscore-1.5.2.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/prototype.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/scriptaculous.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/effects.js" type="text/javascript"></script><script src="/assets/tapestry5/t53-compatibility.js" type="text/javascript"></script><script src="/assets/tapestry5/jquery.js" type="text/javascript"></script><script src="/assets/tapestry5/jquery-noconflict.js" type="text/javascript"></script><script type="text/javascript">require(["t5/core/pageinit"], function(pi) { pi([], [
  "app/analytics",
  [
    "app/karmacracy:init",
    {
      "selector" : "#widget",
      "id" : 309,
      "url" : "http://www.blogstack.info/post/koalite/2014/03/datomic-consultas"
    }
  ],
  "app/facebook",
  "app/googleplus",
  [
    "app/lastPosts:init",
    {
      "id" : "lastPosts",
      "source" : "koalite",
      "name" : "Koalite"
    }
  ],
  [
    "app/lastPosts:init",
    {
      "id" : "lastPosts_0",
      "source" : "blogstack",
      "name" : "Blog Stack"
    }
  ],
  [
    "app/adsensem:init",
    {
      "blogstack" : {
        "adClient" : "ca-pub-3533636310991304",
        "adSlotBillboard" : "1397019380",
        "adSlotHorizontalSkycraper" : "1397019380",
        "adSlotBigRectangle" : "2873752587",
        "adSlotWideSkycraper" : "1896546988"
      }
    }
  ]
]); });</script></body></html>