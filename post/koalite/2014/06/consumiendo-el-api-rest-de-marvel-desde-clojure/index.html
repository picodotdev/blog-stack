<!DOCTYPE html><html data-debug-enabled="true" data-locale="es_ES" xmlns="http://www.w3.org/1999/xhtml"><head><meta content="Apache Tapestry Framework (version 5.4-beta-16)" name="generator"/><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta pagina="Post"/><title>Consumiendo el API Rest de Marvel desde Clojure | Koalite</title><!-- Resources --><link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400,700"/><link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css"/><link title="Portada" type="application/atom+xml" rel="alternate" href="/feed.atom.xml"/><link type="image/png" rel="icon" href="/assets/images/favicon.png"/><meta content="Post" name="tapestry-page-name"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/bootstrap/css/bootstrap.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tapestry.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/exception-frame.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tapestry-console.css"/><link type="text/css" rel="stylesheet" href="/assets/tapestry5/tree.css"/><link type="text/css" rel="stylesheet" href="/assets/css/core.css"/></head><body data-page-initialized="false"><script type="text/javascript">document.write("<div class=\"pageloading-mask\"><div></div></div>");</script><header><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-4"><h1><a class="blogstack" href="/"><span class="glyphicon glyphicon-th"></span> Blog <span class="stack">Stack</span></a></h1></div><div class="col-xs-12 col-sm-12 col-md-6"><nav role="navigation"><ul class="list-unstyled list-inline"><li><a class="header" href="/">Inicio</a></li><li><a class="header" href="/archive">Archivo</a></li><li><a class="header" href="/faq">Preguntas frecuentes</a></li><li><a class="header" href="/faq#aggregate">¿Quieres agregar tu bitácora?</a></li></ul></nav></div><div class="col-xs-6 col-sm-6 col-md-2"><a title="Fuente RSS, ¡suscríbete a BS!" alt="Fuente RSS" class="header" href="/feed.atom.xml"><span class="header icon entypo"></span></a><a title="Twitter, ¡sigue a BS!" alt="Twitter" class="header" href="http://twitter.com/blogstackinfo"><span class="header icon entypo-social"></span></a></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><h4>Un poco más que un agregador/planeta de bitácoras sobre programación, desarrollo, software libre, gnu/linux, tecnología, ...</h4></div></div></div><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div class="imagen-cabecera"><div class="imagen"><div class="col-xs-12 col-sm-12 col-md-12" id="billboard"></div></div></div></div></div></div></header><div class="container-fluid content"><div class="row"><div class="col-xs-12 col-sm-12 col-md-8 content"><article itemtype="http://schema.org/BlogPosting" itemscope=""><a id="content"></a><header><h2><a href="/post/koalite/2014/06/consumiendo-el-api-rest-de-marvel-desde-clojure"><span itemprop="headline">Consumiendo el API Rest de Marvel desde Clojure</span></a></h2></header><section class="post-data"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div><span>Escrito por <span itemprop="author">Juan María Hernández</span> en la bitácora <a href="http://blog.koalite.com/">Koalite</a>, <a href="http://feedproxy.google.com/~r/KoalitesBlog/~3/cYFc6NjwNhE/"><span itemprop="sameAs">artículo original</span></a></span></div><div><span datetime="2014-06-30T09:06" itemprop="datePublished">Publicado el lunes, 30 de junio de 2014 a las 09:06 UTC</span></div><div><span>
Etiquetado como
rest, clojure, development</span></div></div></div></section><div class="text-justify post-content"><div class="share-this only-twitter"><span displayText="Tweet" class="st_twitter_vcount" st_url="http://www.blogstack.info/post/koalite/2014/06/consumiendo-el-api-rest-de-marvel-desde-clojure" st_title="Consumiendo el API Rest de Marvel desde Clojure | Koalite"></span></div><script src="http://w.sharethis.com/button/buttons.js" type="text/javascript"></script><script type="text/javascript">stLight.options({publisher: "ur-3b2014fd-82e-9968-7e00-5ee51fb88bb2", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script><span itemprop="name"><p><img src="http://blog.koalite.com/wp-content/uploads/logo-marvel.png" alt="logo-marvel" width="400" height="163" /></p> 
<p>Hoy en d&iacute;a la necesidad de integrar unos sistemas con otros es innegable, hasta el punto de que t&eacute;rminos como API, antes reservados a programadores, ahora est&aacute;n en boca de todos y se usan como una herramienta de marketing m&aacute;s (todos sabemos que un proyecto no es serio si no se despliega en la nube y cuenta con un API de integraci&oacute;n). </p> 
<p>Por suerte o por desgracia (<a href="http://www.genbetadev.com/metodologias-de-programacion/interoperabilidad-en-el-siglo-xxi">lo siento, Jos&eacute; Juan</a>), la mayor&iacute;a de APIs que nos encontramos actualmente son APIs REST (o algo parecido a REST) que mueven datos serializados en JSON utilizando el protocolo HTTP. Casi todos los lenguajes cuentan con librer&iacute;as m&aacute;s o menos especializadas para consumir este tipo de APIs, y en este post vamos a ver lo sencillo que es podemos consumir un API REST desde Clojure</p> 
<h3>El API REST de Marvel</h3> 
<p>Desde hace un tiempo Marvel tiene publicada <a href="https://developer.marvel.com/">un API para acceder a la informaci&oacute;n de sus c&oacute;mics</a>. Este API es gratuita (con algunas limitaciones) y expone un mont&oacute;n de informaci&oacute;n para los fan&aacute;ticos de los c&oacute;mics (entre los que debo reconocer que <em>no</em> me incluyo), por lo que nos viene muy bien para jugar un poco con ella.</p> 
<p>Para poder utilizarla, deberemos darlos de alta como desarrollador y nos proporcionar&aacute; dos claves, una p&uacute;blica y una privada, que podremos utilizar para hacer nuestras peticiones. La documentaci&oacute;n es muy completa y explica bastante bien todo el proceso.</p> 
<p>Lo m&aacute;s importante que debemos tener en cuenta es que para realizar una petici&oacute;n deberemos a&ntilde;adir a la URL correspondiente los siguientes par&aacute;metros:</p> 
<ul> 
 <li><code>ts</code>: es un timestamp que nos sirve para identificar la llamada y que debe ser &uacute;nico en cada llamada.</li> 
 <li><code>apikey</code>: es nuestra clave <em>p&uacute;blica</em>.</li> 
 <li><code>hash</code>: es el hash md5 del texto resultando de concatenar el timestamp, nuestra clave p&uacute;blica y nuestra clave privada.</li> 
</ul> 
<p>Los datos devueltos por la API van envueltos en varios objetos JSON, pero lo que realmente interesa est&aacute; dentro de la propiedad <code>data</code> del objeto devuelto, donde encontraremos propiedades necesarias para la paginaci&oacute;n de resultados (<code>offset</code>, <code>limit</code>, <code>count</code> y <code>total</code>) y los resultados propiamente dichos (<code>results</code>).</p> 
<h3>Consumiendo el API desde Clojure</h3> 
<p>Despu&eacute;s de esta r&aacute;pida (e incompleta) introducci&oacute;n al API de Marvel, vamos a ver c&oacute;mo podemos consumirla desde Clojure. Para consumir el API usaremos la librer&iacute;a <a href="https://github.com/dakrone/clj-http">clj-http</a> que es un wrapper sobre los <a href="http://hc.apache.org/">HttpComponentes de Apache</a>. Deberemos <a href="http://blog.koalite.com/2013/01/estructura-de-un-proyecto-con-clojure/" title="Estructura de un proyecto con Clojure">a&ntilde;adirla como dependencia en el fichero project.clj</a>:</p> 
<pre>
(defproject ...
  :dependencies [[org.clojure/cloure &quot;1.5.1&quot;]
                 [clj-http &quot;0.9.2&quot;]])
</pre> 
<p>Una vez incluida la dependencia, tendremos que referenciarla en nuestro c&oacute;digo:</p> 
<pre>
(ns marvel-clj.core
  (:require [clj-http.client :as http]))
</pre> 
<p>Partiendo de la manera de usar la API que explic&aacute;bamos antes, es f&aacute;cil imaginarse que lo m&aacute;s complicado es casi construir la URL. Para ello, vamos a definir algunas funciones de apoyo:</p> 
<pre>
(def public-key &quot;YOUR_PUBLIC_KEY_HERE&quot;)
(def private-key &quot;YOUR_PRIVATE_KEY_HERE&quot;)

(def base-url &quot;http://gateway.marvel.com/v1/public&quot;)

(defn md5 [text]
  (let [d (.. (doto (java.security.MessageDigest/getInstance &quot;MD5&quot;)
                .reset
                (.update (.getBytes text)))
              digest)]
    (apply str (map (partial format &quot;%02x&quot;) d))))

(defn build-url [path]
  (let [ts (quot (System/currentTimeMillis) 1000)
        hash (md5 (str ts private-key public-key))]
    (str base-url path &quot;?ts=&quot; ts &quot;&amp;apikey=&quot; public-key &quot;&amp;hash=&quot; hash)))
</pre> 
<p>Lo m&aacute;s feo de todo ese c&oacute;digo es tener que usar java interop para generar el MD5. Existen librer&iacute;as “nativas” de Clojure para ello, pero he preferido no meter m&aacute;s dependencias externas. Seamos positivos, gracias a ello podemos ver el uso de la macro <a href="http://clojuredocs.org/clojure_core/1.2.0/clojure.core/doto">doto</a> para realizar varias acciones sobre un mismo objeto java y la macro <a href="http://clojure.org/java_interop#Java Interop-The Dot special form-(.. Classname-symbol member+)">..</a> para encadenar llamadas al estilo de <a href="http://clojuredocs.org/clojure_core/clojure.core/-%3E">-&gt;</a> (est&aacute; claro que al dise&ntilde;ar clojure no pensaron mucho en el SEO). Salvado el tema del MD5, construir la URL consiste en concatenar unos cuantos strings y poco m&aacute;s.</p> 
<p>Para ayudarnos a invocar el API, podemos crear una funci&oacute;n que se encargue de construir la url correctamente, parsear el json resultante y quedarse con la parte interesante. </p> 
<p>Suena bastante m&aacute;s complicado de lo que es:</p> 
<pre>
(defn get-json [path]
  (get-in (http/get (build-url path) {:as :json}) [:body :data]))
</pre> 
<p>La funci&oacute;n <code>get</code> nos permite realizar peticiones HTTP GET a una URL y podemos pasarle un map con distintas opciones. En este caso, le estamos indicando que queremos que interprete la respuesta como json con <code>:as :json</code>. Eso nos devolvera el json de la respuesta representando como un map de Clojure, por lo que podemos tratarlo con las funciones t&iacute;picas de maps, por ejemplo <code>get-in</code> para acceder a valores anidados (ser&iacute;a algo as&iacute; como hacer <code>result.body.data</code> en javascript).</p> 
<p>Una vez montada esta tremenda infraestructura de unas 15 l&iacute;neas de c&oacute;digo, consumir el API es un juego de ni&ntilde;os. Por ejemplo podr&iacute;amos tener las siguientes funciones para acceder a los comics, los personajes o la informaci&oacute;n de un personaje:</p> 
<pre>
(defn get-comics []
  (get-json &quot;/comics&quot;))

(defn get-characters []
  (get-json &quot;/characters&quot;))

(defn get-character [id]
  (get-json (str &quot;/characters/&quot; id)))
</pre> 
<p>Obviamente esto no es m&aacute;s que un ejemplo y si quisi&eacute;ramos usar esto de verdad deber&iacute;amos tener en cuenta aspectos cr&iacute;ticos como la paginaci&oacute;n, pero creo que es f&aacute;cil hacerse una idea de c&oacute;mo ser&iacute;a. De todas formas, si quieres ver c&oacute;mo se podr&iacute;a implementar, <strong><a href="https://gist.github.com/jmhdez/bef0d14a8da26abf2c4e">puedes ver el c&oacute;digo completo en este gist.</a></strong></p> 
<h3>Resumen</h3> 
<p>Consumir un API REST desde Clojure es muy sencillo desde el punto de vista t&eacute;cnico. A fin de cuentas, el formato json se ajusta muy bien a las estructuras de datos de clojure (maps y secuencias) y un protocolo tan orientado a datos como REST encaja muy bien con la filosof&iacute;a de datos y funciones de Clojure.</p> 
<p>La parte complicada de cualquier API REST no es tanto consumirla, sino <em>consumirla correctamente</em>. Como se explica en <a href="http://www.genbetadev.com/metodologias-de-programacion/interoperabilidad-en-el-siglo-xxi">el post de Jos&eacute; Juan que citaba al principio</a>, <em>un API REST no tiene una especificaci&oacute;n formal</em> que pueda ser validada mec&aacute;nicamente, por lo que a la hora de consumirla (y de mantenerla) es necesario ser m&aacute;s cuidadoso.</p> 
<p><strong>Posts relacionados:</strong></p>
<ol> 
 <li><a href="http://blog.koalite.com/2013/03/tutorial-compojure-iv-exponiendo-un-api-rest/" title="Tutorial Compojure IV: Exponiendo un API REST">Tutorial Compojure IV: Exponiendo un API REST</a></li> 
 <li><a href="http://blog.koalite.com/2013/01/estructura-de-un-proyecto-con-clojure/" title="Estructura de un proyecto con Clojure">Estructura de un proyecto con Clojure</a></li> 
 <li><a href="http://blog.koalite.com/2013/02/project-euler-problema-4-con-clojure/" title="Project Euler: Problema 4 con clojure">Project Euler: Problema 4 con clojure</a></li> 
</ol>
<img src="http://feeds.feedburner.com/~r/KoalitesBlog/~4/cYFc6NjwNhE" height="1" width="1" /></span></div><section><a id="share"></a><h1>Compartir</h1><div class="share-this"><span displayText="Tweet" class="st_twitter_vcount" st_url="http://www.blogstack.info/post/koalite/2014/06/consumiendo-el-api-rest-de-marvel-desde-clojure" st_title="Consumiendo el API Rest de Marvel desde Clojure | Koalite"></span><span displayText="Facebook" class="st_facebook_vcount" st_url="http://www.blogstack.info/post/koalite/2014/06/consumiendo-el-api-rest-de-marvel-desde-clojure" st_title="Consumiendo el API Rest de Marvel desde Clojure | Koalite"></span><span displayText="Google +" class="st_googleplus_vcount" st_url="http://www.blogstack.info/post/koalite/2014/06/consumiendo-el-api-rest-de-marvel-desde-clojure" st_title="Consumiendo el API Rest de Marvel desde Clojure | Koalite"></span><span displayText="LinkedIn" class="st_linkedin_vcount" st_url="http://www.blogstack.info/post/koalite/2014/06/consumiendo-el-api-rest-de-marvel-desde-clojure" st_title="Consumiendo el API Rest de Marvel desde Clojure | Koalite"></span><span displayText="Meneame" class="st_meneame_vcount" st_url="http://www.blogstack.info/post/koalite/2014/06/consumiendo-el-api-rest-de-marvel-desde-clojure" st_title="Consumiendo el API Rest de Marvel desde Clojure | Koalite"></span></div><script src="http://w.sharethis.com/button/buttons.js" type="text/javascript"></script><script type="text/javascript">stLight.options({publisher: "ur-3b2014fd-82e-9968-7e00-5ee51fb88bb2", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script><div id="widget"></div></section><hr/></article></div><div class="col-xs-12 col-sm-12 col-md-4"><aside><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div id="bigRectangle"></div></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section><h3>Redes sociales</h3><p>¿Te gusta Blog Stack? ¡Compártelo!</p><div class="social-networks"><!-- Facebook --><div class="social-network"><div data-share="true" data-show-faces="false" data-action="like" data-width="310" data-layout="box_count" data-href="http://www.blogstack.info/" class="fb-like"></div></div><!-- Google+ --><div class="social-network"><div class="g-plusone" data-href="http://www.blogstack.info/" data-size="tall"></div></div></div></section></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section id="lastPosts"></section></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div id="bigSkycraper"></div></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><section id="lastPosts_0"></section></div></div></aside></div></div></div><footer><div class="container-fluid"><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div class="footer"><a href="/">Blog Stack</a> por <a href="https://twitter.com/picodotdev/">pico.dev</a> está publicado bajo la licencia de software libre <a href="http://www.gnu.org/licenses/agpl-3.0.html">GNU Affero General Public</a> en <a href="https://github.com/picodotdev/blog-stack">GitHub <span class="entypo-social"></span></a>.<br/>
El contenido agregado conserva la licencia de su bitácora.<br/>
«Powered by» <a href="https://github.com/picodotdev/blogstack">Blog Stack</a>, <a href="http://tapestry.apache.org/">Apache Tapestry</a>, <a href="https://www.openshift.com/">OpenShift</a>, <a href="https://pages.github.com/">GitHub Pages</a>, <a href="http://www.oracle.com/es/technologies/java/overview/index.html">Java</a> y más software libre o de código abierto, inspirado en <a href="http://octopress.org/">Octopress</a>.<br/><span class="copyleft">©</span> pico.dev 2015
</div></div></div></div></footer><div id="fb-root"></div><script type="text/javascript">var require = {
  "waitSeconds" : 300,
  "shim" : {
    "t5/core/typeahead" : [
      "jquery"
    ],
    "bootstrap/affix" : [
      "bootstrap/transition"
    ],
    "bootstrap/alert" : [
      "bootstrap/transition"
    ],
    "bootstrap/modal" : [
      "bootstrap/transition"
    ],
    "bootstrap/tab" : [
      "bootstrap/transition"
    ],
    "bootstrap/transition" : [
      "jquery"
    ],
    "bootstrap/button" : [
      "bootstrap/transition"
    ],
    "bootstrap/scrollspy" : [
      "bootstrap/transition"
    ],
    "bootstrap/collapse" : [
      "bootstrap/transition"
    ],
    "bootstrap/dropdown" : [
      "bootstrap/transition"
    ],
    "bootstrap/tooltip" : [
      "bootstrap/transition"
    ],
    "bootstrap/carousel" : [
      "bootstrap/transition"
    ],
    "bootstrap/popover" : [
      "bootstrap/tooltip"
    ]
  },
  "baseUrl" : "/modules"
};
</script><script src="/assets/tapestry5/require.js" type="text/javascript"></script><script src="/assets/tapestry5/underscore-1.5.2.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/prototype.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/scriptaculous.js" type="text/javascript"></script><script src="/assets/tapestry5/scriptaculous_1_9_0/effects.js" type="text/javascript"></script><script src="/assets/tapestry5/t53-compatibility.js" type="text/javascript"></script><script src="/assets/tapestry5/jquery.js" type="text/javascript"></script><script src="/assets/tapestry5/jquery-noconflict.js" type="text/javascript"></script><script type="text/javascript">require(["t5/core/pageinit"], function(pi) { pi([], [
  "app/analytics",
  [
    "app/karmacracy:init",
    {
      "selector" : "#widget",
      "id" : 650,
      "url" : "http://www.blogstack.info/post/koalite/2014/06/consumiendo-el-api-rest-de-marvel-desde-clojure"
    }
  ],
  "app/facebook",
  "app/googleplus",
  [
    "app/lastPosts:init",
    {
      "id" : "lastPosts",
      "source" : "koalite",
      "name" : "Koalite"
    }
  ],
  [
    "app/lastPosts:init",
    {
      "id" : "lastPosts_0",
      "source" : "blogstack",
      "name" : "Blog Stack"
    }
  ],
  [
    "app/adsensem:init",
    {
      "blogstack" : {
        "adClient" : "ca-pub-3533636310991304",
        "adSlot" : "1397019380"
      }
    }
  ]
]); });</script></body></html>